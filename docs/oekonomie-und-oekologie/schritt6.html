<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handlungsm√∂glichkeiten</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .lesson-header {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: white;
            padding: 40px;
            border-radius: 20px 20px 0 0;
        }

        .lesson-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .lesson-content {
            padding: 40px;
            line-height: 1.8;
        }

        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .info-box p {
            color: #856404;
            line-height: 1.8;
        }

        .info-box strong {
            color: #664d03;
        }

        .article-section {
            background: #e7f3ff;
            border: 3px solid #2196F3;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }

        .article-section h3 {
            color: #1565C0;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        details {
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #2196F3;
        }

        summary {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            color: #1565C0;
            padding: 10px;
            user-select: none;
            transition: color 0.3s;
        }

        summary:hover {
            color: #0D47A1;
        }

        details[open] summary {
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
        }

        .article-iframe {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 10px;
            margin-top: 15px;
        }

        .assignment-box {
            background: #e8f5e9;
            border: 3px solid #2e7d32;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .assignment-box h3 {
            color: #1b5e20;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .assignment-box h4 {
            color: #2e7d32;
            margin: 20px 0 10px 0;
            font-size: 1.2em;
        }

        .assignment-box ul {
            margin: 15px 0 15px 30px;
            line-height: 2;
        }

        .assignment-box li {
            color: #1b5e20;
            margin: 10px 0;
        }

        .danger-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .danger-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #66bb6a;
            text-align: center;
            font-weight: bold;
            color: #2e7d32;
        }

        .danger-item span {
            font-size: 2em;
            display: block;
            margin-bottom: 10px;
        }

        .guidelines-box {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .guidelines-box h4 {
            color: #e65100;
            margin-bottom: 15px;
        }

        .guidelines-box ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        .guidelines-box li {
            color: #e65100;
            margin: 8px 0;
        }

        .upload-section {
            background: #f5f5f5;
            border: 3px dashed #2e7d32;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }

        .upload-section h3 {
            color: #1b5e20;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .upload-area {
            background: white;
            border: 2px solid #c8e6c9;
            border-radius: 10px;
            padding: 40px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #e8f5e9;
            border-color: #2e7d32;
        }

        .upload-area.dragover {
            background: #c8e6c9;
            border-color: #1b5e20;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            color: #2e7d32;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #666;
            font-size: 1.1em;
        }

        #fileInput {
            display: none;
        }

        .preview-container {
            margin: 20px 0;
            display: none;
        }

        .preview-container.show {
            display: block;
        }

        .preview-image {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin: 20px 0;
        }

        .file-info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: left;
        }

        .file-info p {
            color: #1b5e20;
            margin: 5px 0;
        }

        .remove-file-btn {
            background: #f44336;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
            transition: all 0.2s;
        }

        .remove-file-btn:hover {
            background: #d32f2f;
            transform: scale(1.05);
        }

        .portfolio-box {
            background: #e8f5e9;
            border: 3px solid #2e7d32;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .portfolio-box h3 {
            color: #1b5e20;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .portfolio-box textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #c8e6c9;
            border-radius: 10px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1em;
            resize: vertical;
            margin-bottom: 15px;
        }

        .portfolio-box textarea:focus {
            outline: none;
            border-color: #2e7d32;
            box-shadow: 0 0 10px rgba(46, 125, 50, 0.2);
        }

        .saved-indicator {
            color: #4CAF50;
            font-weight: bold;
            display: none;
            margin-top: 10px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            transform: scale(1.05);
        }

        .btn-back {
            background: #f5f5f5;
            color: #333;
        }

        .btn-complete {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-pdf {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }

        .btn-back-header {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border: 2px solid white;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
            text-decoration: none;
            margin-bottom: 20px;
        }

        .btn-back-header:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .lesson-header h1 {
                font-size: 1.8em;
            }

            .lesson-content {
                padding: 20px;
            }

            .assignment-box {
                padding: 20px;
            }

            .danger-list {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="lesson-header">
            <button class="btn-back-header" onclick="returnToMain()">‚Üê Zur√ºck zur √úbersicht</button>
            <h1>üí° Handlungsm√∂glichkeiten</h1>
            <p style="font-size: 1.1em; margin-top: 10px; opacity: 0.95;">Was k√∂nnen wir konkret tun?</p>
        </div>

        <div class="lesson-content">
            <div class="info-box">
                <p><strong>üìå Kontext:</strong> Die Schweiz ist besonders vom Klimawandel betroffen. In diesem Schritt erarbeiten Sie konkrete Handlungsm√∂glichkeiten zum Schutz vor klimabedingten Gefahren.</p>
            </div>

            <div class="article-section">
                <h3>üá®üá≠ Die Schweiz ‚Äì ein Hotspot des Klimawandels</h3>
                <p style="color: #1565C0; margin-bottom: 15px;">
                    Die Schweiz wird besonders vom Klimawandel betroffen sein, wie Sie im folgenden Artikel nachlesen k√∂nnen:
                </p>
                
                <details>
                    <summary>üì∞ SRF-Artikel √∂ffnen: "Die Schweiz ‚Äì ein Hotspot des Klimawandels"</summary>
                    <div style="margin-top: 15px;">
                        <p style="color: #666; margin-bottom: 15px; font-size: 0.95em;">
                            <strong>Quelle:</strong> Schweizer Radio und Fernsehen (SRF)<br>
                            <strong>Link:</strong> <a href="https://www.srf.ch/news/schweiz/neue-klimaszenarien-die-schweiz-ein-hotspot-des-klimawandels-1" target="_blank" style="color: #2196F3; text-decoration: none; font-weight: bold;">Artikel auf SRF.ch √∂ffnen ‚Üí</a>
                        </p>
                        <iframe 
                            class="article-iframe" 
                            src="https://www.srf.ch/news/schweiz/neue-klimaszenarien-die-schweiz-ein-hotspot-des-klimawandels-1"
                            title="SRF Artikel √ºber Klimawandel in der Schweiz">
                        </iframe>
                        <p style="color: #999; font-size: 0.85em; margin-top: 10px; font-style: italic;">
                            Falls der Artikel nicht geladen wird, k√∂nnen Sie ihn √ºber den Link oben direkt auf SRF.ch lesen.
                        </p>
                    </div>
                </details>
            </div>

            <div class="assignment-box">
                <h3>‚úèÔ∏è Auftrag: MindMap erstellen</h3>
                
                <p style="color: #1b5e20; font-size: 1.1em; margin-bottom: 20px;">
                    <strong>Erstellen Sie eine MindMap von Hand</strong>, in der Sie zusammenfassen, was Menschen in der Schweiz konkret tun k√∂nnen, um sich vor folgenden vier Gefahren zu sch√ºtzen:
                </p>

                <div class="danger-list">
                    <div class="danger-item">
                        <span>üå°Ô∏è</span>
                        Hitze
                    </div>
                    <div class="danger-item">
                        <span>üí®</span>
                        Schlechte Luftqualit√§t
                    </div>
                    <div class="danger-item">
                        <span>‚õàÔ∏è</span>
                        Unwetter
                    </div>
                    <div class="danger-item">
                        <span>ü¶†</span>
                        Krankheiten & Pandemien
                    </div>
                </div>

                <h4>üîç Besondere Hinweise:</h4>
                <ul>
                    <li>Bei <strong>Krankheiten & Pandemien</strong>: Gehen Sie speziell auf das <strong>Immunsystem</strong> ein</li>
                    <li>Notieren Sie die verwendeten <strong>Quellen hinten auf die MindMap</strong></li>
                </ul>

                <div class="guidelines-box">
                    <h4>‚ö†Ô∏è Wichtige Arbeitsrichtlinien:</h4>
                    <ul>
                        <li><strong>Verwenden Sie nur seri√∂se Quellen</strong> (z.B. BAG, MeteoSchweiz, wissenschaftliche Institutionen, anerkannte Medien)</li>
                        <li><strong>KI darf nur zum Finden von geeigneten Internetquellen verwendet werden</strong></li>
                        <li>Die MindMap wird <strong>von Hand</strong> erstellt (nicht digital)</li>
                    </ul>
                </div>

                <h4>üí° Tipps f√ºr eine gute MindMap:</h4>
                <ul>
                    <li>Verwenden Sie Farben zur Unterscheidung der Ebenen der Mindmap und/ oder zur Unterscheidung der vier Hauptbereiche</li>
                    <li>Strukturieren Sie klar: Hauptgefahr ‚Üí Unterkategorien ‚Üí konkrete Ma√ünahmen</li>
                    <li>Nutzen Sie Symbole und kleine Zeichnungen zur Visualisierung</li>
                    <li>Achten Sie auf Lesbarkeit</li>
                </ul>
            </div>

            <div class="upload-section">
                <h3>üì∏ MindMap hochladen</h3>
                <p style="color: #666; margin-bottom: 20px;">
                    Fotografieren oder scannen Sie Ihre fertige MindMap und laden Sie sie hier hoch.
                </p>
                
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üì§</div>
                    <div class="upload-text">
                        <strong>Klicken Sie hier oder ziehen Sie eine Datei hierher</strong><br>
                        <span style="font-size: 0.9em; color: #999;">Unterst√ºtzte Formate: JPG, PNG, PDF (max. 10 MB)</span>
                    </div>
                </div>
                
                <input type="file" id="fileInput" accept="image/*,.pdf" onchange="handleFileSelect(event)">
                
                <div class="preview-container" id="previewContainer">
                    <h4 style="color: #1b5e20; margin-bottom: 15px;">Vorschau:</h4>
                    <img id="previewImage" class="preview-image" alt="MindMap Vorschau">
                    <div class="file-info" id="fileInfo"></div>
                    <button class="remove-file-btn" onclick="removeFile()">Datei entfernen</button>
                </div>
            </div>

            <div class="portfolio-box">
                <h3>üìù Mein Lernjournal: Schritt 6</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    <strong>Reflexion:</strong>
                </p>
                <ul style="margin: 10px 0 15px 20px; line-height: 1.8; color: #666;">
                    <li>Was waren die wichtigsten Erkenntnisse aus Ihrer Recherche?</li>
                    <li>Welche Handlungsm√∂glichkeiten fanden Sie am wichtigsten oder √ºberraschendsten?</li>
                    <li>Was nehmen Sie pers√∂nlich mit aus dieser Aufgabe?</li>
                </ul>
                <textarea 
                    id="portfolio-text" 
                    placeholder="Ihre Reflexion hier eingeben..."
                    oninput="savePortfolio()"></textarea>
                <div class="saved-indicator" id="saved-indicator">‚úì Automatisch gespeichert</div>
            </div>

            <div class="button-group">
                <button class="btn-back" onclick="returnToMain()">
                    ‚Üê Zur√ºck zur √úbersicht
                </button>
                <button class="btn-pdf" onclick="downloadPDF()">
                    üìÑ PDF Schritt 6 herunterladen
                </button>
                <button class="btn-complete" onclick="completeStep()">
                    Schritt abschlie√üen und weiter ‚Üí
                </button>
            </div>
        </div>
    </div>

    <script>
        let uploadedFile = null;

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.add('dragover');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.remove('dragover');
            }, false);
        });

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            // Check file size (10 MB max)
            if (file.size > 10 * 1024 * 1024) {
                alert('Die Datei ist zu gro√ü. Bitte w√§hlen Sie eine Datei unter 10 MB.');
                return;
            }

            // Check file type
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                alert('Bitte w√§hlen Sie eine JPG, PNG oder PDF Datei.');
                return;
            }

            uploadedFile = file;

            // Show preview
            const previewContainer = document.getElementById('previewContainer');
            const previewImage = document.getElementById('previewImage');
            const fileInfo = document.getElementById('fileInfo');

            if (file.type === 'application/pdf') {
                previewImage.style.display = 'none';
                fileInfo.innerHTML = `
                    <p><strong>üìÑ PDF hochgeladen</strong></p>
                    <p>Dateiname: ${file.name}</p>
                    <p>Gr√∂√üe: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                `;
            } else {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                };
                reader.readAsDataURL(file);

                fileInfo.innerHTML = `
                    <p><strong>‚úì Bild hochgeladen</strong></p>
                    <p>Dateiname: ${file.name}</p>
                    <p>Gr√∂√üe: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                `;
            }

            previewContainer.classList.add('show');

            // Save to localStorage
            saveUploadedFile(file);
        }

        function removeFile() {
            uploadedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('previewContainer').classList.remove('show');
            
            // Remove from localStorage
            let progress = JSON.parse(localStorage.getItem('learningProgress') || '{"completedPoints":[],"currentPoint":1,"texts":{},"images":{}}');
            if (progress.images) {
                delete progress.images['6'];
            }
            localStorage.setItem('learningProgress', JSON.stringify(progress));
        }

        function saveUploadedFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                let progress = JSON.parse(localStorage.getItem('learningProgress') || '{"completedPoints":[],"currentPoint":1,"texts":{},"images":{}}');
                
                if (!progress.images) {
                    progress.images = {};
                }
                
                progress.images['6'] = {
                    data: e.target.result,
                    name: file.name,
                    type: file.type,
                    size: file.size
                };
                
                localStorage.setItem('learningProgress', JSON.stringify(progress));
            };
            reader.readAsDataURL(file);
        }

        function loadUploadedFile() {
            const saved = localStorage.getItem('learningProgress');
            if (saved) {
                const progress = JSON.parse(saved);
                if (progress.images && progress.images['6']) {
                    const fileData = progress.images['6'];
                    const previewContainer = document.getElementById('previewContainer');
                    const previewImage = document.getElementById('previewImage');
                    const fileInfo = document.getElementById('fileInfo');

                    if (fileData.type === 'application/pdf') {
                        previewImage.style.display = 'none';
                        fileInfo.innerHTML = `
                            <p><strong>üìÑ PDF gespeichert</strong></p>
                            <p>Dateiname: ${fileData.name}</p>
                            <p>Gr√∂√üe: ${(fileData.size / 1024 / 1024).toFixed(2)} MB</p>
                        `;
                    } else {
                        previewImage.src = fileData.data;
                        previewImage.style.display = 'block';
                        fileInfo.innerHTML = `
                            <p><strong>‚úì Bild gespeichert</strong></p>
                            <p>Dateiname: ${fileData.name}</p>
                            <p>Gr√∂√üe: ${(fileData.size / 1024 / 1024).toFixed(2)} MB</p>
                        `;
                    }

                    previewContainer.classList.add('show');
                }
            }
        }

        function loadPortfolio() {
            const saved = localStorage.getItem('learningProgress');
            if (saved) {
                const progress = JSON.parse(saved);
                const portfolioText = progress.texts && progress.texts['6'] ? progress.texts['6'] : '';
                document.getElementById('portfolio-text').value = portfolioText;
            }
        }

        function savePortfolio() {
            const text = document.getElementById('portfolio-text').value;
            
            let progress = {
                completedPoints: [],
                currentPoint: 1,
                texts: {},
                images: {}
            };
            
            const saved = localStorage.getItem('learningProgress');
            if (saved) {
                progress = JSON.parse(saved);
            }
            
            if (!progress.texts) {
                progress.texts = {};
            }
            
            progress.texts['6'] = text;
            
            localStorage.setItem('learningProgress', JSON.stringify(progress));
            
            const indicator = document.getElementById('saved-indicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        async function downloadPDF() {
            const portfolioText = document.getElementById('portfolio-text').value.trim();
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(20);
            doc.text("Lernjournal: Handlungsm√∂glichkeiten", 20, 20);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(11);
            doc.text(`Datum: ${new Date().toLocaleDateString('de-DE')}`, 20, 30);
            
            let currentY = 45;
            
            // MindMap Image
            const saved = localStorage.getItem('learningProgress');
            if (saved) {
                const progress = JSON.parse(saved);
                if (progress.images && progress.images['6']) {
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(14);
                    doc.text("MindMap:", 20, currentY);
                    currentY += 7;
                    
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(10);
                    doc.text(`Datei: ${progress.images['6'].name}`, 20, currentY);
                    currentY += 8;
                    
                    // Add image if it's not a PDF
                    if (progress.images['6'].type !== 'application/pdf') {
                        try {
                            const imgData = progress.images['6'].data;
                            
                            // Create an image element to get actual dimensions
                            const img = new Image();
                            img.src = imgData;
                            
                            await new Promise((resolve) => {
                                img.onload = resolve;
                            });
                            
                            const imgWidth = img.width;
                            const imgHeight = img.height;
                            const aspectRatio = imgWidth / imgHeight;
                            
                            // Calculate dimensions to fit on page
                            const maxWidth = 170; // mm
                            const maxHeight = 200; // mm
                            
                            let finalWidth, finalHeight;
                            
                            if (aspectRatio > maxWidth / maxHeight) {
                                // Image is wider - fit to width
                                finalWidth = maxWidth;
                                finalHeight = maxWidth / aspectRatio;
                            } else {
                                // Image is taller - fit to height
                                finalHeight = maxHeight;
                                finalWidth = maxHeight * aspectRatio;
                            }
                            
                            // Check if we need a new page
                            if (currentY + finalHeight > 270) {
                                doc.addPage();
                                currentY = 20;
                            }
                            
                            // Determine image format
                            let imgFormat = 'JPEG';
                            if (progress.images['6'].type === 'image/png') {
                                imgFormat = 'PNG';
                            }
                            
                            // Add image with calculated dimensions
                            doc.addImage(imgData, imgFormat, 20, currentY, finalWidth, finalHeight);
                            currentY += finalHeight + 10;
                            
                        } catch (error) {
                            console.error('Fehler beim Einf√ºgen des Bildes:', error);
                            doc.setFont("helvetica", "italic");
                            doc.setFontSize(10);
                            doc.text("(Bild konnte nicht eingef√ºgt werden - Fehler: " + error.message + ")", 20, currentY, {maxWidth: 170});
                            currentY += 15;
                        }
                    } else {
                        doc.setFont("helvetica", "italic");
                        doc.setFontSize(10);
                        doc.text("(PDF-Datei wurde hochgeladen - kann nicht als Bild angezeigt werden)", 20, currentY, {maxWidth: 170});
                        currentY += 15;
                    }
                }
            }
            
            // Add new page for reflection if needed
            if (portfolioText !== '' && currentY > 240) {
                doc.addPage();
                currentY = 20;
            }
            
            // Journal
            if (portfolioText !== '') {
                doc.setFont("helvetica", "bold");
                doc.setFontSize(14);
                doc.text("Reflexion:", 20, currentY);
                currentY += 8;
                
                doc.setFont("helvetica", "normal");
                doc.setFontSize(11);
                const lines = doc.splitTextToSize(portfolioText, 170);
                doc.text(lines, 20, currentY);
            }
            
            doc.save('Lernjournal_Schritt6_Handlungsmoeglichkeiten.pdf');
        }

        function completeStep() {
            const portfolioText = document.getElementById('portfolio-text').value.trim();
            const saved = localStorage.getItem('learningProgress');
            let hasMindMap = false;
            
            if (saved) {
                const progress = JSON.parse(saved);
                hasMindMap = progress.images && progress.images['6'];
            }
            
            if (!hasMindMap) {
                const confirm = window.confirm('Sie haben noch keine MindMap hochgeladen. M√∂chten Sie trotzdem fortfahren?');
                if (!confirm) return;
            }
            
            if (portfolioText === '') {
                const confirm = window.confirm('Sie haben noch nichts ins Lernjournal eingetragen. M√∂chten Sie trotzdem fortfahren?');
                if (!confirm) return;
            }
            
            savePortfolio();
            
            let progress = JSON.parse(localStorage.getItem('learningProgress') || '{"completedPoints":[],"currentPoint":1,"texts":{},"images":{}}');
            
            if (!progress.completedPoints.includes(6)) {
                progress.completedPoints.push(6);
                progress.currentPoint = 7;
                localStorage.setItem('learningProgress', JSON.stringify(progress));
            }
            
            alert('‚úì Schritt 6 abgeschlossen!\n\nIhr Lernjournal-Eintrag und Ihre MindMap wurden gespeichert.');
            window.location.href = 'index.html';
        }

        function returnToMain() {
            window.location.href = 'index.html';
        }

        // Load saved data on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadPortfolio();
            loadUploadedFile();
        });
    </script>
</body>
</html>
